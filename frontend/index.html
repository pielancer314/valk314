<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valk314 - Pi Network Integration</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/chart.js" rel="stylesheet">
    <style>
        .feature-card {
            transition: transform 0.3s ease;
        }
        .feature-card:hover {
            transform: translateY(-5px);
        }
        .risk-low { color: #28a745; }
        .risk-medium { color: #ffc107; }
        .risk-high { color: #dc3545; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">Valk314</a>
            <button id="connectWallet" class="btn btn-outline-light">Connect Wallet</button>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Banking Dashboard -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Banking Dashboard</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="card feature-card">
                                    <div class="card-body text-center">
                                        <h6>Balance</h6>
                                        <h4 id="accountBalance">0.00 Pi</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card feature-card">
                                    <div class="card-body text-center">
                                        <h6>Active Contracts</h6>
                                        <h4 id="activeContracts">0</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card feature-card">
                                    <div class="card-body text-center">
                                        <h6>Risk Score</h6>
                                        <h4 id="riskScore">--</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card feature-card">
                                    <div class="card-body text-center">
                                        <h6>Investment Returns</h6>
                                        <h4 id="investmentReturns">0.00%</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Smart Banking Features -->
            <div class="col-md-6">
                <!-- Transaction Form -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Smart Transaction</h5>
                        <form id="transactionForm">
                            <div class="mb-3">
                                <label for="recipientId" class="form-label">Recipient ID</label>
                                <input type="text" class="form-control" id="recipientId" required>
                            </div>
                            <div class="mb-3">
                                <label for="amount" class="form-label">Amount (Pi)</label>
                                <input type="number" class="form-control" id="amount" min="0" step="0.1" required>
                            </div>
                            <div class="mb-3">
                                <label for="transactionType" class="form-label">Transaction Type</label>
                                <select class="form-select" id="transactionType">
                                    <option value="transfer">Transfer</option>
                                    <option value="investment">Investment</option>
                                    <option value="smart-contract">Smart Contract</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Process Transaction</button>
                        </form>
                    </div>
                </div>

                <!-- Investment Strategies -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Investment Strategies</h5>
                        <div class="mb-3">
                            <select class="form-select" id="strategyType">
                                <option value="conservative">Conservative</option>
                                <option value="moderate">Moderate</option>
                                <option value="aggressive">Aggressive</option>
                            </select>
                        </div>
                        <button id="deployStrategy" class="btn btn-success">Deploy Strategy</button>
                    </div>
                </div>
            </div>

            <!-- Analytics and Risk Assessment -->
            <div class="col-md-6">
                <!-- Analytics Chart -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Transaction Analytics</h5>
                        <canvas id="analyticsChart"></canvas>
                    </div>
                </div>

                <!-- Risk Assessment -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Risk Assessment</h5>
                        <div id="riskAssessment">
                            <div class="progress mb-3">
                                <div id="riskIndicator" class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div id="riskRecommendations" class="list-group">
                                <!-- Risk recommendations will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transaction History -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Transaction History</h5>
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Type</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Risk Score</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionHistory">
                                    <!-- Transaction history will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Messages -->
        <div class="row mt-4">
            <div class="col-12">
                <div id="messages"></div>
            </div>
        </div>
    </div>

    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Initialize Pi SDK
        const Pi = window.Pi;
        Pi.init({ version: "2.0", sandbox: true });

        let currentUser = null;
        let currentAccount = null;
        let analyticsChart = null;

        // Initialize Chart
        function initializeAnalyticsChart() {
            const ctx = document.getElementById('analyticsChart').getContext('2d');
            analyticsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Transaction Volume',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Update Dashboard
        async function updateDashboard() {
            if (!currentAccount) return;

            try {
                const analytics = await fetch(`/api/banking/accounts/${currentAccount.id}/analytics`).then(r => r.json());
                
                document.getElementById('accountBalance').textContent = `${currentAccount.balance.toFixed(2)} Pi`;
                document.getElementById('activeContracts').textContent = analytics.activeSmartContracts;
                document.getElementById('riskScore').textContent = analytics.riskProfile.averageRiskScore.toFixed(2);
                
                updateRiskIndicator(analytics.riskProfile.averageRiskScore);
                updateRiskRecommendations(analytics.riskProfile.recommendations);
                updateAnalyticsChart(analytics);
            } catch (error) {
                showMessage(error.message, 'danger');
            }
        }

        // Risk Indicator
        function updateRiskIndicator(score) {
            const indicator = document.getElementById('riskIndicator');
            const percentage = score * 100;
            indicator.style.width = `${percentage}%`;
            
            if (score > 0.7) {
                indicator.className = 'progress-bar bg-danger';
            } else if (score > 0.4) {
                indicator.className = 'progress-bar bg-warning';
            } else {
                indicator.className = 'progress-bar bg-success';
            }
        }

        // Risk Recommendations
        function updateRiskRecommendations(recommendations) {
            const container = document.getElementById('riskRecommendations');
            container.innerHTML = recommendations.map(rec => `
                <div class="list-group-item">
                    <i class="bi bi-info-circle"></i> ${rec}
                </div>
            `).join('');
        }

        // Analytics Chart
        function updateAnalyticsChart(analytics) {
            if (!analyticsChart) return;

            const transactions = analytics.transactions || [];
            analyticsChart.data.labels = transactions.map(tx => new Date(tx.timestamp).toLocaleDateString());
            analyticsChart.data.datasets[0].data = transactions.map(tx => tx.amount);
            analyticsChart.update();
        }

        // Transaction Form Handler
        document.getElementById('transactionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentAccount) {
                showMessage('Please connect your wallet first', 'warning');
                return;
            }

            const recipientId = document.getElementById('recipientId').value;
            const amount = document.getElementById('amount').value;
            const type = document.getElementById('transactionType').value;

            try {
                const transaction = await fetch('/api/banking/transactions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fromAccountId: currentAccount.id,
                        toAccountId: recipientId,
                        amount: parseFloat(amount),
                        type
                    })
                }).then(r => r.json());

                showMessage('Transaction processed successfully!', 'success');
                updateDashboard();
            } catch (error) {
                showMessage(error.message, 'danger');
            }
        });

        // Investment Strategy Handler
        document.getElementById('deployStrategy').addEventListener('click', async () => {
            if (!currentAccount) {
                showMessage('Please connect your wallet first', 'warning');
                return;
            }

            const strategyType = document.getElementById('strategyType').value;
            
            try {
                const strategy = await fetch('/api/banking/investment-strategies', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        accountId: currentAccount.id,
                        strategy: strategyType
                    })
                }).then(r => r.json());

                showMessage('Investment strategy deployed successfully!', 'success');
                updateDashboard();
            } catch (error) {
                showMessage(error.message, 'danger');
            }
        });

        // Wallet Connection
        document.getElementById('connectWallet').addEventListener('click', async () => {
            try {
                const auth = await Pi.authenticate(['payments'], onIncompletePaymentFound);
                if (auth) {
                    currentUser = auth;
                    
                    // Create or fetch banking account
                    const account = await fetch('/api/banking/accounts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: auth.user.username,
                            initialBalance: 0
                        })
                    }).then(r => r.json());

                    currentAccount = account;
                    showMessage('Wallet connected successfully!', 'success');
                    updateDashboard();
                }
            } catch (error) {
                showMessage(error.message, 'danger');
            }
        });

        // Helper Functions
        function showMessage(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.getElementById('messages').appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 5000);
        }

        // Initialize
        initializeAnalyticsChart();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
